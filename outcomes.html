<!DOCTYPE html>
<html>
  <head>
    <title>2019-nCoV Estimated Case Outcomes</title>
    <meta http-equiv="content-type" content="text/html" charset="utf-8" />

    <link rel="stylesheet" type="text/css" href = "styles.css?v=2020-02-01" />

    <script lang="javascript" src="./dist/sql-wasm.js"></script>
    <script lang="javascript" src="./dist/d3.v5.min.js"></script>
    <script lang="javascript" src="./dist/d3-scale-cluster.min.js"></script>
    <script lang="javascript" src="./dist/topojson.min.js"></script>
    <script lang="javascript" src="./dist/versor.min.js"></script>
    <script lang="javascript" src="./dist/moment.min.js"></script>
    <script lang="javascript" src="./dist/moment-strftime.js"></script>
    <script lang="javascript" src="./js/app.js?v=2020-02-01-01"></script>
    <script lang="javascript" src="./js/queries.js?v=2020-02-01-01"></script>

    <script lang="javascript">
      const SETTINGS = {
        locale: 'en-US',
        db_path: './data/nCoV.sqlite3?v=2020-02-02-0330',
        topo_path: './data/globe.simple.json?v=6',
      }

      const width = 1500
      const height = 1200
      const margin = {top: 10, right: 20, bottom: 40, left: 150}
      const db = new Database(SETTINGS.db_path)

      const legend_width = 75
      const legend_height = 25
    </script>
    <style type="text/css">
      .outcomes .tick text {
        font-family: 'DejaVu Mono';
      }

      .container.outcomes {
        display: inline-block;
        position: relative;
        width: 100%;
        padding-bottom: 33.33%;
        vertical-align: top;
        margin-top: 1em;
        /* overflow: hidden; */
      }
  </style>
  </head>
  <body>
    <h2 style="line-height: 130%; text-align: center">2019-nCoV Outcomes</h2>
    <h3 style="line-height: 100%;"><span class="x-date"></span></h3>
    <div class="outcomes">
      <div class="container outcomes">
        <svg class="plot outcomes svg-content-responsive"></svg>
      </div>
      <script type="application/javascript">
        const categories = ["unknown", "recovered", "deaths"]

        const x = d3.scaleLinear()
          .range([margin.left, width - margin.right])

        const y = d3.scaleBand()
          .range([margin.top, height - margin.bottom])
          .padding(0.1)

        const svg = d3.select("svg.outcomes")
          .attr("viewBox", [0, 0, width, height])
          .style("overflow", "visible")

        db.load_data()
          .then(() => {
            const date = moment(db.query("SELECT MAX(updated_at) AS updated_at FROM cases")[0].updated_at)
            const date_caption = date.strftime("%d %B %Y %H:%M UTC-5")
            d3.selectAll(".x-date").text(date_caption)

            const data = db.query(Queries.PROPORTIONS)

            y.domain(data.map(d => d.locale))

            const series = d3.stack()
              .keys(categories)
              .offset(d3.stackOffsetExpand)
              (data)

            const color = d3.scaleOrdinal()
              .domain(series.map(d => d.key))
              .range(["rgb(66, 136, 181)", "rgb(105, 189, 169)", "rgb(240, 112, 74)"])
              // .range(["rgb(66, 136, 181)", "rgb(169, 220, 162)", "rgb(240, 112, 74)"])
              .unknown("#ccc")

            const xAxis = g => g
              .attr("transform", `translate(0, ${margin.top})`)
              .call(d3.axisTop(x).ticks(width / 100, "%"))
              .call(g => g.selectAll(".domain").remove())

            const yAxis = function(g) {
              return g
                .attr("transform", `translate(${margin.left},0)`)
                .call(d3.axisLeft(y).tickSizeOuter(0))
                .call(g => g.selectAll(".domain").remove())
            }

            svg.append("g")
              .selectAll("g")
              .data(series)
              .enter().append("g")
                .attr("fill", d => color(d.key))
              .selectAll("rect")
              .data(d => d)
              .join("rect")
                .attr("x", d => x(d[0]))
                .attr("y", (d, i) => y(d.data.locale))
                .attr("width", d => x(d[1]) - x(d[0]))
                .attr("height", y.bandwidth())

            svg.append("g").attr("class", "y axis y-axis").call(yAxis)
            svg.append("g").attr("class", "x axis x-axis").call(xAxis)
            console.log(categories.map(color))
            let legend = svg.append("g")
              .attr("class", "legend")
              .attr("transform", `translate(${margin.left}, ${height - (margin.bottom/1.125)})`)
              .selectAll("rect")
              .data(categories)
              .join("g")

            legend.append("rect")
              .attr("width", legend_width)
              .attr("height", legend_height / 2)
              .attr("transform", (d, i) => `translate(${i * (legend_width + 5)}, 0)`)
              .style("fill", d => color(d))

            legend.append("text")
              .attr("width", legend_width)
              .attr("height", legend_height / 2)
              .attr("fill", "white")
              .attr("transform", (d, i) => `translate(${i * (legend_width + 5)}, 0)`)
              .text(d => d)
              .attr("y", legend_height / 2.5)
              .attr("x", legend_width / 2)
              .attr("text-anchor", "middle")
          })
      </script>
  </body>
</html>
